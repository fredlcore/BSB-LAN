name: Build ESP32 recovery artifacts

on:
  push:
    branches: ["master"]
    paths-ignore:
      - "docs/**"
  workflow_dispatch:

permissions:
  contents: read
  actions: write  # needed to upload artifacts

concurrency:
  group: recovery-build-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-recovery:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: esp32-devkit
            fqbn: esp32:esp32:esp32
            board_options: "PartitionScheme=min_spiffs"
            out_name: recovery-devkit-merged.bin
            manifest_name: bsb-lan-recovery-devkit.json
            display_name: "ESP32-DevKit"

          - name: esp32-evb
            fqbn: esp32:esp32:esp32-evb
            board_options: "PartitionScheme=min_spiffs"
            out_name: recovery-olimex-evb-merged.bin
            manifest_name: bsb-lan-recovery-olimex-evb.json
            display_name: "Olimex EVB"

          - name: esp32-poe-iso
            fqbn: esp32:esp32:esp32-poe-iso
            board_options: "PartitionScheme=min_spiffs"
            out_name: recovery-olimex-poe-iso-merged.bin
            manifest_name: bsb-lan-recovery-olimex-poe-iso.json
            display_name: "Olimex POE-ISO"

    steps:
      - uses: actions/checkout@v4

      - name: Install arduino-cli
        run: |
          curl -fsSL https://raw.githubusercontent.com/arduino/arduino-cli/master/install.sh | sh
          sudo mv ./bin/arduino-cli /usr/local/bin/arduino-cli

      - name: Install ESP32 core
        run: |
          arduino-cli core update-index
          arduino-cli core install esp32:esp32

      - name: Setup config files
        run: |
          cp BSB_LAN/BSB_LAN_config.h.default BSB_LAN/BSB_LAN_config.h
          cp BSB_LAN/BSB_LAN_custom_defs.h.default BSB_LAN/BSB_LAN_custom_defs.h

      - name: Install dependencies
        run: arduino-cli lib install Ethernet

      - name: Compile (export binaries)
        run: |
          mkdir -p build/${{ matrix.name }}
          arduino-cli compile \
            --fqbn ${{ matrix.fqbn }} \
            --board-options ${{ matrix.board_options }} \
            --libraries BSB_LAN/libraries \
            --build-path build/${{ matrix.name }} \
            --export-binaries \
            BSB_LAN

      - name: Install esptool
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install esptool

      - name: Create recovery output (this board)
        run: |
          BUILD="build/${{ matrix.name }}"
          BOOTLOADER="$(ls "$BUILD"/*.bootloader.bin | head -n 1)"
          PARTITIONS="$(ls "$BUILD"/*.partitions.bin | head -n 1)"
          APPBIN="$(ls "$BUILD"/*.bin | grep -vE '\.bootloader\.bin$|\.partitions\.bin$' | head -n 1)"
          BOOTAPP0="$(find "$HOME/.arduino15/packages/esp32" -name boot_app0.bin | head -n 1)"

          test -n "$BOOTLOADER"
          test -n "$PARTITIONS"
          test -n "$APPBIN"
          test -n "$BOOTAPP0"

          mkdir -p recovery_out/bin recovery_out/manifests

          python3 -m esptool --chip esp32 merge-bin -o "recovery_out/bin/${{ matrix.out_name }}" \
            --flash-mode dio --flash-size 4MB \
            0x1000  "$BOOTLOADER" \
            0x8000  "$PARTITIONS" \
            0xE000  "$BOOTAPP0" \
            0x10000 "$APPBIN"

          cat > "recovery_out/manifests/${{ matrix.manifest_name }}" <<JSON
          {
            "name": "BSB-LAN Recovery (${{ matrix.display_name }}, min_spiffs + OTA)",
            "version": "recovery",
            "builds": [
              { "chipFamily": "ESP32", "parts": [ { "path": "../bin/${{ matrix.out_name }}", "offset": 0 } ] }
            ]
          }
          JSON

      - name: Upload artifact (this board)
        uses: actions/upload-artifact@v4
        with:
          name: recovery-${{ matrix.name }}
          path: recovery_out
          retention-days: 7