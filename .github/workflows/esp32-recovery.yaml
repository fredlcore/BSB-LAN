name: Build ESP32 recovery artifacts + Deploy GitHub Pages

on:
  push:
    branches: ["master"]
  workflow_dispatch:

permissions:
  contents: read
  actions: write
  pages: write
  id-token: write

concurrency:
  group: master-build-deploy
  cancel-in-progress: true

jobs:
  build-recovery:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Arduino CLI
        uses: arduino/setup-arduino-cli@v2
        with:
          version: "1.x"

      - name: Setup config files
        run: |
          cp BSB_LAN/BSB_LAN_config.h.default BSB_LAN/BSB_LAN_config.h
          cp BSB_LAN/BSB_LAN_custom_defs.h.default BSB_LAN/BSB_LAN_custom_defs.h

      - name: Install ESP32 core + libs (once)
        run: |
          arduino-cli core update-index
          arduino-cli core install esp32:esp32
          arduino-cli lib install Ethernet

      - name: Install custom 16MB partition table into ESP32 core
        shell: bash
        run: |
          set -euo pipefail

          PARTSRC="BSB_LAN/partitions/default_16MB.csv"
          test -f "$PARTSRC"

          # Hard-coded (GitHub Actions runner layout for Arduino CLI)
          # The '*' covers the ESP32 core version directory.
          PARTDIR="$HOME/.arduino15/packages/esp32/hardware/esp32"/*/tools/partitions

          # Expand and validate
          test -d $PARTDIR

          cp -v "$PARTSRC" $PARTDIR/default_16MB.csv
          echo "Installed partitions to: $PARTDIR"
          ls -la $PARTDIR | head -n 50

      - name: Install esptool
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install esptool

      - name: Build all recovery binaries (stop on first failure)
        shell: bash
        run: |
          set -euo pipefail

          # Fixed offsets for Arduino ESP32
          OFF_BOOT=0x1000
          OFF_PART=0x8000
          OFF_BOOTAPP0=0xE000
          OFF_APP0=0x10000

          mkdir -p recovery_out/bin recovery_out/manifests

          # Hard-coded location of boot_app0.bin in Arduino-ESP32 core
          BOOTAPP0="$HOME/.arduino15/packages/esp32/hardware/esp32"/*/tools/partitions/boot_app0.bin
          test -f $BOOTAPP0

          build_one () {
            local name="$1"
            local fqbn="$2"
            local board_opts="$3"      # can be empty
            local flash_size="$4"      # 4MB / 16MB
            local extra_props="${5:-}" # optional extra compile args

            local out_bin="recovery-${name}-merged.bin"
            local out_manifest="bsb-lan-recovery-${name}.json"

            echo ""
            echo "============================================================"
            echo "Building: ${name}"
            echo "  FQBN: ${fqbn}"
            echo "  Options: ${board_opts:-<none>}"
            echo "  Extra: ${extra_props:-<none>}"
            echo "============================================================"

            mkdir -p "build/${name}"

            local -a ARGS
            ARGS=(
              --fqbn "${fqbn}"
              --libraries BSB_LAN/libraries
              --build-path "build/${name}"
              --export-binaries
              BSB_LAN
            )

            if [ -n "${board_opts}" ]; then
              ARGS=(--board-options "${board_opts}" "${ARGS[@]}")
            fi

            if [ -n "${extra_props}" ]; then
              local -a EXTRA_ARR=(${extra_props})
              ARGS=("${EXTRA_ARR[@]}" "${ARGS[@]}")
            fi

            arduino-cli compile "${ARGS[@]}"

            local BUILD="build/${name}"
            local BOOTLOADER="${BUILD}/BSB_LAN.ino.bootloader.bin"
            local PARTITIONS="${BUILD}/BSB_LAN.ino.partitions.bin"
            local APPBIN="${BUILD}/BSB_LAN.ino.bin"

            test -f "$BOOTLOADER"
            test -f "$PARTITIONS"
            test -f "$APPBIN"

            python3 -m esptool --chip esp32 merge-bin -o "recovery_out/bin/${out_bin}" \
              --flash-mode dio --flash-size "${flash_size}" \
              "${OFF_BOOT}"     "$BOOTLOADER" \
              "${OFF_PART}"     "$PARTITIONS" \
              "${OFF_BOOTAPP0}" $BOOTAPP0 \
              "${OFF_APP0}"     "$APPBIN"

            cat > "recovery_out/manifests/${out_manifest}" <<JSON
          {
            "name": "BSB-LAN Recovery (${name})",
            "version": "recovery",
            "builds": [
              { "chipFamily": "ESP32", "parts": [ { "path": "../bin/${out_bin}", "offset": 0 } ] }
            ]
          }
          JSON
          }

          build_one "esp32-devkit"        "esp32:esp32:esp32"          "PartitionScheme=min_spiffs" "4MB"
          build_one "esp32-evb"           "esp32:esp32:esp32-evb"      "PartitionScheme=min_spiffs" "4MB"
          build_one "esp32-poe-iso"       "esp32:esp32:esp32-poe-iso"  "PartitionScheme=min_spiffs" "4MB"
          build_one "esp32-poe-iso-16mb"  "esp32:esp32:esp32-poe-iso"  "" "16MB" "--build-property build.partitions=default_16MB --build-property upload.maximum_size=6553600 --build-property compiler.cpp.extra_flags=-DCUSTOM_PARTITION_TABLE"

      - name: Upload recovery artifact (all boards)
        uses: actions/upload-artifact@v4
        with:
          name: recovery-all
          path: recovery_out

  deploy:
    needs: build-recovery
    runs-on: ubuntu-latest
    environment:
      name: github-pages

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5

      - name: Install MkDocs + plugins
        run: |
          python -m pip install --upgrade pip
          if [ -f docs/requirements.txt ]; then
            pip install -r docs/requirements.txt
          else
            pip install mkdocs mkdocs-static-i18n mkdocs-autorefs pymdown-extensions
          fi

      - name: Build docs to publish/
        run: |
          rm -rf publish
          mkdir -p publish
          mkdocs build -f mkdocs.yml -d publish

      - name: Download recovery artifacts
        uses: actions/download-artifact@v4
        with:
          name: recovery-all
          path: artifacts

      - name: Assemble /recovery into publish/
        run: |
          mkdir -p publish/recovery/bin publish/recovery/manifests
          find artifacts -type f -path '*/bin/*' -exec cp -v {} publish/recovery/bin/ \;
          find artifacts -type f -path '*/manifests/*' -exec cp -v {} publish/recovery/manifests/ \;

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: publish

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4