name: Build ESP32 recovery artifacts + Deploy GitHub Pages

on:
  push:
    branches: ["master"]
  workflow_dispatch:

permissions:
  contents: read
  actions: write
  pages: write
  id-token: write

concurrency:
  group: master-build-deploy
  cancel-in-progress: true

jobs:
  build-recovery:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Arduino CLI
        uses: arduino/setup-arduino-cli@v2
        with:
          version: "1.x"

      - name: Setup config files
        run: |
          cp BSB_LAN/BSB_LAN_config.h.default BSB_LAN/BSB_LAN_config.h
          cp BSB_LAN/BSB_LAN_custom_defs.h.default BSB_LAN/BSB_LAN_custom_defs.h

      - name: Install ESP32 core + libs (once)
        run: |
          arduino-cli core update-index
          arduino-cli core install esp32:esp32
          arduino-cli lib install Ethernet

      - name: Install esptool
        run: |
          python3 -m pip install --upgrade pip
          python3 -m pip install esptool

      - name: Build all recovery binaries (stop on first failure)
        shell: bash
        run: |
          set -euo pipefail

          # Fixed offsets for Arduino ESP32 (typical and matches your layouts)
          OFF_BOOT=0x1000
          OFF_PART=0x8000
          OFF_BOOTAPP0=0xE000
          OFF_APP0=0x10000

          mkdir -p recovery_out/bin recovery_out/manifests
          mkdir -p .arduino-build-cache

          build_one () {
            local name="$1"          # e.g. esp32-poe-iso-16mb
            local fqbn="$2"
            local board_opts="$3"
            local flash_size="$4"    # 4MB / 16MB

            local out_bin="recovery-${name}-merged.bin"
            local out_manifest="bsb-lan-recovery-${name}.json"

            echo "Building: ${name}"

            mkdir -p "build/${name}"

            arduino-cli compile \
              --fqbn "${fqbn}" \
              --board-options "${board_opts}" \
              --libraries BSB_LAN/libraries \
              --build-cache-path .arduino-build-cache \
              --build-path "build/${name}" \
              --export-binaries \
              BSB_LAN

            local BUILD="build/${name}"
            local BOOTLOADER PARTITIONS APPBIN BOOTAPP0

            BOOTLOADER="$(ls "$BUILD"/*.bootloader.bin | head -n 1)"
            PARTITIONS="$(ls "$BUILD"/*.partitions.bin | head -n 1)"
            # pick the main sketch binary (exclude bootloader + partitions)
            APPBIN="$(ls "$BUILD"/*.bin | grep -vE '\.bootloader\.bin$|\.partitions\.bin$' | head -n 1)"
            BOOTAPP0="$(find "$HOME/.arduino15/packages/esp32" -name boot_app0.bin | head -n 1)"

            ls -la $BUILD

            test -n "$BOOTLOADER"
            test -n "$PARTITIONS"
            test -n "$APPBIN"
            test -n "$BOOTAPP0"

            python3 -m esptool --chip esp32 merge-bin -o "recovery_out/bin/${out_bin}" \
              --flash-mode dio --flash-size "${flash_size}" \
              "${OFF_BOOT}"     "$BOOTLOADER" \
              "${OFF_PART}"     "$PARTITIONS" \
              "${OFF_BOOTAPP0}" "$BOOTAPP0" \
              "${OFF_APP0}"     "$APPBIN"

            cat > "recovery_out/manifests/${out_manifest}" <<JSON
          {
            "name": "BSB-LAN Recovery (${name})",
            "version": "recovery",
            "builds": [
              { "chipFamily": "ESP32", "parts": [ { "path": "../bin/${out_bin}", "offset": 0 } ] }
            ]
          }
          JSON
          }

          # name, fqbn, board_options, flash_size
          build_one "esp32-devkit"         "esp32:esp32:esp32"          "PartitionScheme=min_spiffs"       "4MB"
          build_one "esp32-evb"            "esp32:esp32:esp32-evb"      "PartitionScheme=min_spiffs"       "4MB"
          build_one "esp32-poe-iso"        "esp32:esp32:esp32-poe-iso"  "PartitionScheme=min_spiffs"       "4MB"
          build_one "esp32-poe-iso-16mb"   "esp32:esp32:esp32-poe-iso"  "PartitionScheme=default_16MB.csv" "16MB"

      - name: Upload recovery artifact (all boards)
        uses: actions/upload-artifact@v4
        with:
          name: recovery-all
          path: recovery_out

  deploy:
    needs: build-recovery
    runs-on: ubuntu-latest
    environment:
      name: github-pages

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5

      - name: Install MkDocs + plugins
        run: |
          python -m pip install --upgrade pip
          if [ -f docs/requirements.txt ]; then
            pip install -r docs/requirements.txt
          else
            pip install mkdocs mkdocs-static-i18n mkdocs-autorefs pymdown-extensions
          fi

      - name: Build docs to publish/
        run: |
          rm -rf publish
          mkdir -p publish
          mkdocs build -f mkdocs.yml -d publish

      - name: Download recovery artifacts
        uses: actions/download-artifact@v4
        with:
          name: recovery-all
          path: artifacts

      - name: Assemble /recovery into publish/
        run: |
          mkdir -p publish/recovery/bin publish/recovery/manifests
          find artifacts -type f -path '*/bin/*' -exec cp -v {} publish/recovery/bin/ \;
          find artifacts -type f -path '*/manifests/*' -exec cp -v {} publish/recovery/manifests/ \;

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: publish

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4